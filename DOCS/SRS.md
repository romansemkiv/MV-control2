# SRS — MV Control System

## 1. Вступ

### 1.1 Мета
Створити Web‑систему для керування мультив’юверами та роутингом через протоколи Evertz Quartz та NEXX‑API.

### 1.2 Область застосування
- Підключення до NEXX (REST) для параметрів MV.
- Підключення до Quartz (TCP) для роутингу джерел.

### 1.3 Терміни
- MV: Multiviewer.
- UMD: Over/Under Monitor Display.
- Source: джерело відео.

## 2. Загальний опис

### 2.1 Ролі
- `admin`
- `user`

### 2.2 Користувацькі сценарії (Use Cases)
**Admin:**
- Додає параметри протоколів.
- Перевіряє статус останнього оновлення.
- Створює користувачів, керує доступами.

**User:**
- Бачить стан MV і роутингу.
- Змінює layout, sources, UMD, PCM.

### 2.3 Обмеження
- Протоколи повільні, потрібні rate‑limit і захист від масових оновлень.
- Оновлення стану 1 раз/добу або вручну.
- Один користувач редагує один MV за раз; одночасно у системі може бути кілька користувачів.

## 3. Функціональні вимоги

### 3.1 Автентифікація
- Мінімальна auth система.
- Перший користувач автоматично admin.
- Пароль обов’язковий при першому логіні.
- Відновлення пароля відсутнє, скидання лише адміном.

### 3.2 Управління користувачами
- CRUD користувачів.
- Призначення ролі.
- Призначення доступу до Sources і MV.

### 3.3 Quartz (routing)
- Читання імен входів/виходів: `.RD`, `.RS`.
- Читання поточного роутингу: `.I`.
- Перемикання: `.SV<output,input>`.
- Мапінг output↔MV window обов’язковий для роутинга:
  - Адмін задає кількість MV.
  - Кожен MV має 16 output‑каналів.
  - Відповідність: `mv1.window1 -> out1`, `mv2.window1 -> out17` і т.д.
  - Для UI output‑номер прив’язаний до конкретного вікна MV і використовується при роутингу.
  - Кількість Sources задається глобально, label відповідає номеру input.

### 3.4 NEXX‑API (MV параметри)
- Читання і запис параметрів MV.
- Керування layout, borders, font.
- Керування UMD (3 шари).
- Керування PCM Audio bars.
- Enum‑мапінги формуються вручну і можуть змінюватися.
 - Кількість MV читається з параметра `Enabled Multiviewers`.
 - Фактична кількість вікон визначається layout.
 - У системі доступно 43 layout.

### 3.5 UMD та PCM
- UMD має 3 шари, кожен шар має тип:
  - Off, Static, Dynamic line 1, NTP time, NTP time w offset.
- UMD Text редагується тільки для Static.
- PCM Audio bars: 0, 2, 4, 6, 8, 12, 16.

### 3.5 Пресети
- Збереження/виклик/експорт/імпорт.
- Пресети прив’язані до користувача.
- Вікно пресетів:
  - Верх: вибір MV.
  - Низ: чекбокси параметрів.
  - Ті ж опції при збереженні і виклику.

### 3.6 UI
- Темна тема, сучасний вигляд.
- Глобальні параметри MV.
- Вибір MV для редагування.
- Відображення layout з пронумерованими вікнами і показом output‑номера для кожного вікна.
- Панель параметрів обраного вікна.
- Вікно з preview layout, вибір по кліку.
 - Роутинг: вибір вікна → вибір Source → команда Quartz `.SV` з output‑номером цього вікна.

### 3.7 Оновлення і кешування
- Після зчитування параметри зберігаються в БД.
- Оновлення стану 1 раз на добу або вручну (кнопка update).
- В UI відображається звіт: успішно/неуспішно, дата.

## 4. Нефункціональні вимоги
- Docker‑деплой (Portainer, build у Docker).
- Авто‑оновлення через webhook.
- Стабільність: rate‑limit, throttle.
- Немає audit‑логів.
- Multi‑tenancy не підтримується.

## 4.1 Обмеження протоколів
### Quartz
- ASCII TCP, request‑response, одна команда на підключення.
- Termination: `\\r\\n`.
- Timeout 1–5 секунд.
- Помилки повертаються як `.E`.

### NEXX‑API
- Rate limiting: бажано < 10 req/sec.
- URL‑encoding для спецсимволів у текстових полях.
- Індекси: MV 0..119, Window 0..15, UMD layer 0..2.
- Обмеження: до 120 MV, до 16 вікон на MV, 3 UMD.
- Формат кольору: `0xRRGGBB`, Alpha 0–255.

## 5. Дані

### 5.1 Основні сутності
- User, Role.
- Source.
- Multiviewer.
- Window.
- Preset.
- State snapshots.

### 5.2 Мінімальна БД
- Users, UserAccess, Sources, MV, Presets, State.

## 6. Інтеграції
- Quartz TCP, request‑response.
- NEXX REST, EV/GET/SET, API key/JWT.

## 7. Пріоритети (MoSCoW)

### Must
- Auth, ролі, доступи.
- Quartz read routing + switch.
- NEXX read/write базових параметрів MV.
- UI: MV list, layout preview, window settings.
- Пресети (save/load) всередині системи.

### Should
- Імпорт/експорт пресетів.
- Ручний refresh із throttle.
- Статус останнього оновлення.

### Could
- Нічний sync.
- Додаткові валідації та UX‑покращення.

### Won’t
- Live‑оновлення (WebSocket).
- Audit‑лог дій користувачів.
- Multi‑tenancy.
